# Toolbox

This container has tools installed such as Helm, the kubectl command, etc. This is intended as a 
"bootstrap" container that can bring up the rest of the platform.

This is a work in progress!

# Prerequisites

* You have access to a running Kubernetes cluster with at least 8 GB of RAM
* You have the kubectl command installed, and it can access the cluster
* Your cluster has access to the forgerock docker images.


# Toolbox workflow

1. If you intend to use a private git configuration repository, you must create a secret with
a git private SSH key. See the git section below. You can use the public read only forgeops-init repo 
for testing. A dummy SSH key is still required as a placeholder. The bin/bootstrap.sh script
will create this.

2. Optional: Create a custom.yaml file that contains the high level setting overrides for the Helm
charts. This includes things such as the image registry source, the domain name, etc. You
can copy the custom.yaml sample in the Helm directory and use it as a starting point. If you do not create a custom.yaml
file a default one will be generated by bin/bootstrap.sh. To create the custom configmap:

`kubectl create configmap platform-config --from-file=custom.yaml`

3. Start the toolbox pod in Kubernetes. You can download 
https://stash.forgerock.org/projects/CLOUD/repos/forgeops/raw/etc/toolbox.yaml?at=refs%2Fheads%2Fmaster

or for GKE:
https://stash.forgerock.org/projects/CLOUD/repos/forgeops/raw/etc/toolbox-gke.yaml?at=refs%2Fheads%2Fmaster

If you are using a custom values override, you must edit the above files and uncomment the platform-config
reference in volumeMounts.

Or, alternatively, install directly:

`kubectl create -f 'https://stash.forgerock.org/projects/CLOUD/repos/forgeops/raw/etc/toolbox-gke.yaml?at=refs%2Fheads%2Fmaster'` 

4. Exec into the toolbox pod:  `kubectl exec toolbox -it bash`

6. Run the platform start script: bin/bootstrap.sh 

This will bring up full stack sample Helm chart (cmp-platform) that starts AM, IG, IDM and DS


# Git

To import from or export to a private configuration repository you must create 
a secret that holds the git SSH key that has permissions to read/write to your git repository. 

Github and Stash both support adding "API key" access on a repository level. This is 
preferred over using your 
own personal SSH key. If the git SSH key is compromised the damage is limited to the configuration repository.

An example of generating a key:

` ssh-keygen -t rsa -C "forgeopsrobot@forgrock.com" -f id_rsa -N ''`

This generates the id_rsa and id_rsa.pub files.

Create the required secret:
 
`kubectl create secret generic git-ssh-key --from-file=id_rsa`

The id_rsa.pub key is what you will upload to Stash or Github as the the repository API key 
(check under repository settings).


# Please READ!!

It takes a *very* long time to pull images from the ForgeRock registry. The second
time you run this it should be much faster as the images will be in your Docker cache.
It may take up to 30 minutes to pull all the images.

You may see an error message "Error from server (BadRequest): container "amster" in pod "amster" is waiting to start: ContainerCreating"

This is OK - it just means the container is not present and Kubernetes is still pulling it.

